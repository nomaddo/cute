# Result

## この実験は何をしているのか

将棋の対局で、AIが計算する「評価値」がある一定のラインを**先に超えた側**（これを **first-crossed** と呼びます）が、実際に勝ちやすいかどうかを調べた実験です。

将棋24のレート戦の棋譜データ（約 70,000 局）を使い、以下のことを行いました。

1. 各対局の評価値推移から「評価値が 200 / 300 / 500 / 1000 を先に超えた側」を特定
2. その側が実際に勝ったかどうかを集計
3. レーティング差の影響を統計的に分離して、first-crossed **だけ**の効果を推定

---

## 結論（忙しい方向け）

| しきい値 | first-crossed した側の推定勝率 | していない側の推定勝率 | 差 |
|-------:|:---:|:---:|:---:|
| 300 | 56.2% | 46.8% | +9.4pt |
| 500 | 59.7% | 44.5% | +15.2pt |
| 1000 | 65.4% | 40.9% | +24.5pt |

> いずれもレーティング差 0（互角の相手）を想定した場合の値です。

- **しきい値が大きいほど勝率の差が広がる** ＝ 大きく有利になった側ほど勝ちやすい
- レーティング差を考慮しても、first-crossed の効果は独立して残っている

### 注意点

- これは「有利になった側が勝ちやすい」という直感を定量化したものであり、**因果関係の証明ではありません**。
- 評価値の精度（やねうら王のモデル）やデータの偏りに結果は依存します。
- 高レーティング帯はデータが少なく、数値がぶれやすくなっています。

---

## ロジスティック回帰（logreg）とは何か

ロジスティック回帰は、「ある条件のもとで、勝つか負けるかの確率がどう変わるか」を推定する統計モデルです。ここではレーティング差や first-crossed の有無が勝率にどう影響するかを分析しています。

### モデルに使っている変数（特徴量）の詳しい説明

このモデルには 4 つの変数があります。日常の言葉で言い換えると次のようになります。

#### 1. intercept（切片）

「他のすべての条件がゼロ（レーティング差なし・first-crossed なし）のときの、勝ちやすさのベースライン」です。

- 将棋24では後手の勝率がやや低いため、この値はマイナスになっています。
- 直接「○○%」と読むのではなく、他の変数と組み合わせて最終的な勝率を計算するための出発点です。

#### 2. rating_diff_scaled（レーティング差）

「対局者同士のレーティング差が、勝率にどのくらい影響するか」を表します。

- レーティング差を 100 で割った値（例：レート差 200 → 2.0）を使っています。
- **値が正** ＝ レーティングが高い方が勝ちやすい（当然の結果）
- 例えば odds ratio が 1.31 なら、「レーティングが 100 上がるごとに、勝ちやすさが約 1.31 倍になる」と読めます。

#### 3. first_crossed（先にしきい値を超えたかどうか）

**この実験で最も注目する変数です。**

- 「評価値がしきい値を先に超えた側（first-crossed=1）は、超えていない側（first-crossed=0）に比べて、どのくらい勝ちやすくなるか」を表します。
- 例えば odds ratio が 1.46 なら、「先にしきい値を超えた側は、勝ちやすさが約 1.46 倍になる」と解釈できます。
- しきい値が大きいほど（300→500→1000）、この値が大きくなる ＝ **はっきり有利になるほど勝ちに直結しやすい**。

#### 4. rating_x_first（レーティング差 × first-crossed の交互作用）

「レーティングが高い人が first-crossed したとき、追加で勝ちやすくなるかどうか」を表す変数です。

- **交互作用**とは、2 つの要素が組み合わさったときに生まれる追加の効果のことです。
- 例：レーティングが高い人は有利な局面を確実に勝ちに変換できるため、first-crossed の効果がさらに強まる可能性がある。
- 今回の結果では、この値は小さく（odds ratio ≒ 1.01）、**レーティングによる追加効果はほぼ無視できるレベル**です。つまり、first-crossed の効果はレーティングに関係なくほぼ一定と言えます。

### 出力セクションの読み方

| セクション | 意味 |
|---|---|
| **coefficients (log-odds)** | 各変数の影響度を「対数オッズ」という単位で示したもの。正なら勝ちやすくなる方向、負なら勝ちにくくなる方向。数字の大きさが影響の強さ。 |
| **odds ratios** | coefficients を「何倍勝ちやすくなるか」に変換したもの。**1.0 より大きければ勝ちやすい方向**、小さければ勝ちにくい方向。最も直感的に読める指標。 |
| **predicted win rates** | レーティング差が 0 と仮定したときの予測勝率。first-cross=1 と first-cross=0 の差が「first-crossed の影響の大きさ」。 |
| **expected win rates by rating** | first-crossed した前提で、レーティングごとの予測勝率。レーティングが高い帯ほど勝率が上がるのは当然なので、「伸び方の傾向」を見る。 |

---

## logreg 出力: しきい値 = 300

```
go run ./cmd/logreg -input output_6.parquet -threshold 300 -max-abs-diff 200 -workers 1
```

```
data:
  input: output_6.parquet
  threshold: 300
  rating-scale: 100
  games: 70355 (skipped=7317)
  max-abs-diff: 200
  mean-sente-rating: 1056
  workers: 1
model:
  features: intercept, rating_diff_scaled, first_crossed, rating_x_first
  final-loss: 0.674703
all model:
coefficients (log-odds):
  intercept = -0.128144
  rating_diff_scaled = 0.267747
  first_crossed = 0.379128
  rating_x_first = 0.008681
odds ratios (1.0 = no change):
  rating_diff_scaled = 1.3070
  first_crossed = 1.4610
  rating_x_first = 1.0087
predicted win rates (rating diff = 0, at mean rating):
  first-cross=1: 0.562
  first-cross=0: 0.468
expected win rates by rating (first-cross=1, rating diff = 0):
  rating=300: win_rate=0.546
  rating=600: win_rate=0.553
  rating=900: win_rate=0.559
  rating=1200: win_rate=0.565
  rating=1500: win_rate=0.572
  rating=1800: win_rate=0.578
  rating=2100: win_rate=0.585
  rating=2400: win_rate=0.591
```

### 読み取れること

- 評価値 300 を先に超えた側の勝率は **56.2%**、超えていない側は **46.8%**（約 9.4pt の差）。
- odds ratio 1.46 ＝ 先に 300 を超えると勝ちやすさが **約 1.5 倍** になる。
- rating_x_first の odds ratio が 1.01 とほぼ 1.0 ＝ **この効果はレーティングに関係なく一定**。
- 「300 点程度の小さなリードでも、先に取った側が勝ちやすい」傾向がすでに見える。

---

## logreg 出力: しきい値 = 500

```
go run ./cmd/logreg -input output_6.parquet -threshold 500 -max-abs-diff 200 -workers 1
```

```
data:
  input: output_6.parquet
  threshold: 500
  rating-scale: 100
  games: 69998 (skipped=7674)
  max-abs-diff: 200
  mean-sente-rating: 1055
  workers: 1
model:
  features: intercept, rating_diff_scaled, first_crossed, rating_x_first
  final-loss: 0.655022
all model:
coefficients (log-odds):
  intercept = -0.221375
  rating_diff_scaled = 0.259366
  first_crossed = 0.616289
  rating_x_first = 0.012696
odds ratios (1.0 = no change):
  rating_diff_scaled = 1.2961
  first_crossed = 1.8520
  rating_x_first = 1.0128
predicted win rates (rating diff = 0, at mean rating):
  first-cross=1: 0.597
  first-cross=0: 0.445
expected win rates by rating (first-cross=1, rating diff = 0):
  rating=300: win_rate=0.574
  rating=600: win_rate=0.583
  rating=900: win_rate=0.593
  rating=1200: win_rate=0.602
  rating=1500: win_rate=0.611
  rating=1800: win_rate=0.620
  rating=2100: win_rate=0.629
  rating=2400: win_rate=0.638
```

### 読み取れること

- 評価値 500 を先に超えた側の勝率は **59.7%**、超えていない側は **44.5%**（約 15.2pt の差）。
- odds ratio 1.85 ＝ first-crossed すると勝ちやすさが **約 1.9 倍**。300 のときの 1.46 倍と比べて明確に増加。
- 500 点は「はっきりとした優勢」であり、先に到達できれば勝利にかなり近づくことが読み取れる。

---

## logreg 出力: しきい値 = 1000

```
go run ./cmd/logreg -input output_6.parquet -threshold 1000 -max-abs-diff 200 -workers 1
```

```
data:
  input: output_6.parquet
  threshold: 1000
  rating-scale: 100
  games: 68764 (skipped=8908)
  max-abs-diff: 200
  mean-sente-rating: 1055
  workers: 1
model:
  features: intercept, rating_diff_scaled, first_crossed, rating_x_first
  final-loss: 0.602434
all model:
coefficients (log-odds):
  intercept = -0.369233
  rating_diff_scaled = 0.247968
  first_crossed = 1.007773
  rating_x_first = 0.017344
odds ratios (1.0 = no change):
  rating_diff_scaled = 1.2814
  first_crossed = 2.7395
  rating_x_first = 1.0175
predicted win rates (rating diff = 0, at mean rating):
  first-cross=1: 0.654
  first-cross=0: 0.409
expected win rates by rating (first-cross=1, rating diff = 0):
  rating=300: win_rate=0.624
  rating=600: win_rate=0.636
  rating=900: win_rate=0.648
  rating=1200: win_rate=0.660
  rating=1500: win_rate=0.672
  rating=1800: win_rate=0.683
  rating=2100: win_rate=0.694
  rating=2400: win_rate=0.705
```

### 読み取れること

- 評価値 1000 を先に超えた側の勝率は **65.4%**、超えていない側は **40.9%**（約 24.5pt の差）。
- odds ratio 2.74 ＝ first-crossed すると勝ちやすさが **約 2.7 倍**。非常に大きい効果。
- 1000 点は「明確な優勢（ほぼ勝勢）」であり、先に到達した側はそのまま勝ち切る傾向が強い。
- intercept のマイナスが大きくなっているのは、「1000 に到達しなかった対局は勝率が低い」ことを反映しているだけであり、先手不利を意味するわけではない。

---

## logreg 3 つのしきい値の比較まとめ

| しきい値 | first_crossed の odds ratio | first-cross=1 の勝率 | first-cross=0 の勝率 | 勝率差 |
|-------:|:---:|:---:|:---:|:---:|
| 300 | 1.46 | 56.2% | 46.8% | +9.4pt |
| 500 | 1.85 | 59.7% | 44.5% | +15.2pt |
| 1000 | 2.74 | 65.4% | 40.9% | +24.5pt |

- しきい値が大きくなるほど、first-crossed の odds ratio が急増している。
- どのしきい値でも `rating_x_first` の odds ratio は 1.0 付近 → **レーティングに関係なく効果はほぼ一定**。

---

## レーティング帯別の集計（analyze）

logreg はモデルに基づく推定値ですが、こちらは **実際の対局データの単純集計** です。レーティング帯ごとに「first-crossed した側が何局中何局勝ったか」を数えています。

```
go run ./cmd/analyze -input output_6.parquet -thresholds 200,300,500,1000
```

### しきい値 = 200（小さなリード）

代表的な帯を抜粋します。

| レーティング帯 | first-crossed 回数 | 勝ち | 勝率 |
|---|---:|---:|---:|
| 200–300 | 2,270 | 1,252 | 55.2% |
| 500–600 | 2,830 | 1,553 | 54.9% |
| 1000–1100 | 2,261 | 1,254 | 55.5% |
| 1500–1600 | 1,456 | 821 | 56.4% |
| 2000–2100 | 735 | 409 | 55.6% |

- 200 点程度のごくわずかなリードでも、**どの帯でもおおむね 54～56% の勝率** になっている。
- 差は小さいが、全帯で一貫して 50% を超えている。

### しきい値 = 300

| レーティング帯 | first-crossed 回数 | 勝ち | 勝率 |
|---|---:|---:|---:|
| 200–300 | 2,247 | 1,310 | 58.3% |
| 500–600 | 2,815 | 1,614 | 57.3% |
| 1000–1100 | 2,242 | 1,333 | 59.5% |
| 1500–1600 | 1,452 | 886 | 61.0% |
| 2000–2100 | 730 | 444 | 60.8% |

- 200 より勝率がさらに上がり、**58～61% 程度**。

### しきい値 = 500

| レーティング帯 | first-crossed 回数 | 勝ち | 勝率 |
|---|---:|---:|---:|
| 200–300 | 2,240 | 1,399 | 62.5% |
| 500–600 | 2,812 | 1,758 | 62.5% |
| 1000–1100 | 2,260 | 1,470 | 65.0% |
| 1500–1600 | 1,456 | 972 | 66.8% |
| 2000–2100 | 718 | 477 | 66.4% |

- 500 点の優勢で **62～67%** の勝率。

### しきい値 = 1000（明確な優勢）

| レーティング帯 | first-crossed 回数 | 勝ち | 勝率 |
|---|---:|---:|---:|
| 200–300 | 2,204 | 1,545 | 70.1% |
| 500–600 | 2,756 | 1,970 | 71.5% |
| 1000–1100 | 2,238 | 1,638 | 73.2% |
| 1500–1600 | 1,411 | 1,078 | 76.4% |
| 2000–2100 | 699 | 526 | 75.3% |
| 2500–2600 | 164 | 139 | 84.8% |

- 1000 点の優勢で **70～85%** の勝率。高レーティング帯ほど勝率が高い傾向あり。
- ただし 2500 以上はデータが少なく誤差が大きい。

### 全しきい値の傾向

- **しきい値が大きいほど勝率が上がる**（200: 55% → 300: 59% → 500: 65% → 1000: 73%）
- **レーティングが高い帯ほど、わずかに勝率が高い**（有利な局面を勝ちに変換する技術が高い）
- 高レーティング帯（2500 以上）はサンプル数が少なく、極端な値が出やすいため参考程度

---

## analyze 全データ（しきい値 200 / 300 / 500 / 1000）

<details>
<summary>クリックして全データを表示</summary>

```
threshold=200
player_rate,crossings,wins,win_rate
0-100,10,6,0.600000
100-200,625,342,0.547200
200-300,2270,1252,0.551542
300-400,2776,1529,0.550793
400-500,2960,1579,0.533446
500-600,2830,1553,0.548763
600-700,3188,1726,0.541405
700-800,3307,1791,0.541578
800-900,3094,1661,0.536846
900-1000,2789,1507,0.540337
1000-1100,2261,1254,0.554622
1100-1200,2496,1384,0.554487
1200-1300,2366,1290,0.545224
1300-1400,2228,1228,0.551167
1400-1500,1845,1024,0.555014
1500-1600,1456,821,0.563874
1600-1700,1512,846,0.559524
1700-1800,1287,718,0.557887
1800-1900,1118,602,0.538462
1900-2000,857,474,0.553092
2000-2100,735,409,0.556463
2100-2200,501,303,0.604790
2200-2300,401,243,0.605985
2300-2400,321,177,0.551402
2400-2500,220,135,0.613636
2500-2600,162,92,0.567901
2600-2700,121,72,0.595041
2700-2800,54,32,0.592593
2800-2900,40,28,0.700000
2900-3000,11,4,0.363636
3000-3100,1,1,1.000000
3100-3200,0,0,0.000000
3200-3300,0,0,0.000000

threshold=300
player_rate,crossings,wins,win_rate
0-100,10,5,0.500000
100-200,623,361,0.579454
200-300,2247,1310,0.583000
300-400,2791,1620,0.580437
400-500,2947,1690,0.573465
500-600,2815,1614,0.573357
600-700,3184,1854,0.582286
700-800,3293,1907,0.579107
800-900,3107,1800,0.579337
900-1000,2771,1626,0.586792
1000-1100,2242,1333,0.594558
1100-1200,2516,1486,0.590620
1200-1300,2360,1368,0.579661
1300-1400,2224,1299,0.584083
1400-1500,1844,1106,0.599783
1500-1600,1452,886,0.610193
1600-1700,1508,901,0.597480
1700-1800,1278,793,0.620501
1800-1900,1103,640,0.580236
1900-2000,865,533,0.616185
2000-2100,730,444,0.608219
2100-2200,507,313,0.617357
2200-2300,401,256,0.638404
2300-2400,323,205,0.634675
2400-2500,213,135,0.633803
2500-2600,164,99,0.603659
2600-2700,120,76,0.633333
2700-2800,55,37,0.672727
2800-2900,41,28,0.682927
2900-3000,11,6,0.545455
3000-3100,1,1,1.000000
3100-3200,0,0,0.000000
3200-3300,0,0,0.000000

threshold=500
player_rate,crossings,wins,win_rate
0-100,9,6,0.666667
100-200,610,367,0.601639
200-300,2240,1399,0.624554
300-400,2768,1767,0.638367
400-500,2936,1841,0.627044
500-600,2812,1758,0.625178
600-700,3183,2024,0.635878
700-800,3267,2041,0.624732
800-900,3103,1975,0.636481
900-1000,2735,1769,0.646801
1000-1100,2260,1470,0.650442
1100-1200,2500,1614,0.645600
1200-1300,2338,1478,0.632164
1300-1400,2212,1419,0.641501
1400-1500,1838,1220,0.663765
1500-1600,1456,972,0.667582
1600-1700,1482,952,0.642375
1700-1800,1285,853,0.663813
1800-1900,1088,712,0.654412
1900-2000,867,591,0.681661
2000-2100,718,477,0.664345
2100-2200,500,346,0.692000
2200-2300,401,266,0.663342
2300-2400,326,224,0.687117
2400-2500,212,143,0.674528
2500-2600,160,111,0.693750
2600-2700,121,89,0.735537
2700-2800,55,43,0.781818
2800-2900,39,27,0.692308
2900-3000,12,8,0.666667
3000-3100,1,1,1.000000
3100-3200,0,0,0.000000
3200-3300,0,0,0.000000

threshold=1000
player_rate,crossings,wins,win_rate
0-100,10,9,0.900000
100-200,589,409,0.694397
200-300,2204,1545,0.700998
300-400,2740,1988,0.725547
400-500,2885,2061,0.714385
500-600,2756,1970,0.714804
600-700,3109,2243,0.721454
700-800,3210,2311,0.719938
800-900,3060,2199,0.718627
900-1000,2685,1949,0.725885
1000-1100,2238,1638,0.731903
1100-1200,2475,1838,0.742626
1200-1300,2286,1673,0.731846
1300-1400,2177,1590,0.730363
1400-1500,1805,1348,0.746814
1500-1600,1411,1078,0.763997
1600-1700,1470,1116,0.759184
1700-1800,1253,930,0.742219
1800-1900,1068,818,0.765918
1900-2000,858,668,0.778555
2000-2100,699,526,0.752504
2100-2200,487,390,0.800821
2200-2300,406,315,0.775862
2300-2400,303,241,0.795380
2400-2500,213,162,0.760563
2500-2600,164,139,0.847561
2600-2700,111,93,0.837838
2700-2800,55,47,0.854545
2800-2900,41,33,0.804878
2900-3000,11,8,0.727273
3000-3100,1,1,1.000000
3100-3200,0,0,0.000000
3200-3300,0,0,0.000000
```

</details>

---

## 実行条件

| 項目 | 値 |
|---|---|
| 入力ファイル | `output_6.parquet` |
| 対局数 | 約 70,000 局 |
| max-abs-diff | 200（レート差 200 以内の対局に限定） |
| 先手平均レーティング | 約 1056 |
| しきい値 | 200, 300, 500, 1000 |

### stats について

`stats` コマンドは現在ユーザ個別の統計情報（ユーザ名・レーティング・勝率・得意戦型など）を出力する仕様になっています。個別データは本レポートには含めていません。
